<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Pop the Dot</title>
    <style>
        html,body{margin:0;height:100%;color:#111;font-family:sans-serif}

        /* â–¼ ë°°ê²½ í…Œë§ˆ 3ì¢… */
        body.theme-meadow{
          background:
            radial-gradient(1200px 600px at 80% -10%, rgba(255,255,255,.5), rgba(255,255,255,0)),
            linear-gradient(180deg, #c7ffd1 0%, #b3f1ff 60%, #eafaff 100%);
        }
        body.theme-night{
          background:
            radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,.7), rgba(255,255,255,0) 60%) repeat,
            radial-gradient(2px 2px at 70% 60%, rgba(255,255,255,.6), rgba(255,255,255,0) 60%) repeat,
            linear-gradient(180deg,#0b1020 0%, #0a1530 60%, #000814 100%);
          background-size: 200px 200px, 260px 260px, auto;
          color:#f4f6ff;
        }
        body.theme-ocean{
          background:
            radial-gradient(1200px 600px at 20% -10%, rgba(255,255,255,.35), rgba(255,255,255,0)),
            linear-gradient(180deg,#9be7ff 0%,#5bc0ff 45%,#0077b6 100%);
        }

        /* â–¼ HUD: ì‘ê³  ìœ ì—°í•˜ê²Œ */
        .hud{
          position:fixed;top:8px;left:8px;right:8px;
          display:flex;flex-wrap:wrap;gap:6px;z-index:10;align-items:center;
          padding:4px 6px;border-radius:10px;backdrop-filter: blur(4px);
          background: rgba(255,255,255,.35);
          font-size:14px;line-height:1;
          max-width:calc(100vw - 16px);
        }
        .hud > *{flex:0 0 auto}
        .hud .sp{width:1px;height:18px;background:rgba(0,0,0,.2);margin:0 2px}

        #canvas{display:block;width:100vw;height:100vh;touch-action:manipulation}

        .btn{
          background:#333;border:1px solid #555;padding:6px 8px;border-radius:8px;cursor:pointer;
          color:#fff;font-size:14px
        }
        .btn.icon{padding:6px 8px;min-width:36px;text-align:center}
        .btn:active{transform:translateY(1px)}
    </style>
</head>
<body class="theme-meadow">
<div class="hud">
    <span>â± <span id="time">30.0</span>s</span>
    <span>â­ <span id="score">0</span></span>
    <div class="sp"></div>
    <button id="start" class="btn">Start</button>
    <button id="theme" class="btn" title="ë°°ê²½ í…Œë§ˆ ë°”ê¾¸ê¸°">Meadow</button>
    <button id="bgm-toggle" class="btn icon" title="ë°°ê²½ìŒ On/Off">ğŸ”Š</button>
</div>

<canvas id="canvas"></canvas>

<!-- BGM 1ê³¡ ë¬´í•œ ë°˜ë³µ -->
<audio id="bgm" src="/assets/bgm1.mp3" preload="auto" loop></audio>

<script>
    /* =========================
       ê¸°ë³¸ ìƒìˆ˜/ìƒíƒœ
    ========================= */
    const API = '/api/v1';
    const DURATION = 30_000;

    // ìŠ¤í° ê°„ê²©(ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ ë¹¨ë¼ì§)
    const SPAWN_MAX = 1500, SPAWN_MIN = 900;

    // ë™ì‹œì— ì¡´ì¬í•˜ëŠ” ìµœëŒ€ ìºë¦­í„° ìˆ˜
    const MAX_DOTS = 6;

    // ìˆ˜ëª…/í˜ì´ë“œ(ì•ˆ ëˆ„ë¥´ë©´ ì‚¬ë¼ì§)
    const LIFE_MIN = 1100, LIFE_MAX = 1800; // ms
    const FADE_MS  = 250;

    let userId = localStorage.getItem('userId');
    let sessionId = null;
    let running = false;
    let startMs = 0, nowMs = 0, lastSpawn = 0;
    let score = 0, combo = 0;

    // ì—¬ëŸ¬ ìºë¦­í„° ë™ì‹œ ê´€ë¦¬
    let dots = [];

    const rnd=(a,b)=>Math.random()*(b-a)+a;
    const uuid=()=>crypto.randomUUID();

    async function ensureGuest(){
      if(!userId){
        const nickname = 'Player'+Math.floor(Math.random()*1000);
        const res = await fetch(API+'/auth/guest',{method:'POST',headers:{'Content-Type':'application/json'},
          body: JSON.stringify({nickname})});
        const js = await res.json();
        userId = js.data.userId;
        localStorage.setItem('userId', userId);
      }
    }

    /* =========================
       ìºë¦­í„°(ì¤‘ë³µ í—ˆìš©)
    ========================= */
    const CHARACTERS = ['ğŸ°','ğŸ¶','ğŸ±','ğŸ»','ğŸ¦Š','ğŸ¼','ğŸµ','ğŸ¸','ğŸ¯','ğŸ¹'];

    function currentSpawnInterval(){
      const t = nowMs - startMs;
      const k = Math.min(1, Math.max(0, t / DURATION));
      return SPAWN_MAX + (SPAWN_MIN - SPAWN_MAX)*k;
    }

    function currentLifeSpan(){
      const t = nowMs - startMs;
      const k = Math.min(1, Math.max(0, t / DURATION));
      // ì§„í–‰ë ìˆ˜ë¡ ì•½ê°„ ì§§ì•„ì§
      const min = LIFE_MIN - 100*k;
      const max = LIFE_MAX - 150*k;
      return rnd(Math.max(600, min), Math.max(800, max));
    }

    function spawnOne(){
      const w = innerWidth, h = innerHeight;
      const r = rnd(28, 52);
      const emoji = CHARACTERS[Math.floor(Math.random()*CHARACTERS.length)]; // ê°™ì€ ì´ëª¨ì§€ ì—¬ëŸ¬ ë²ˆ ê°€ëŠ¥(ì¤‘ë³µ í—ˆìš©)
      const life = currentLifeSpan();
      const born = performance.now();
      const expireAt = born + life;
      dots.push({ x: rnd(r, w-r), y: rnd(r, h-r), r, emoji, born, expireAt });
    }

    function spawnSome(){
      // í•œ ë²ˆì— 1~3ê°œ ì¶”ê°€(ìµœëŒ€ì¹˜ ì´ˆê³¼ ì•ˆ í•˜ê²Œ)
      const want = 1 + Math.floor(Math.random()*3); // 1 ~ 3
      const can = Math.max(0, MAX_DOTS - dots.length);
      const n = Math.min(want, can);
      for(let i=0;i<n;i++) spawnOne();
    }

    /* =========================
       ìº”ë²„ìŠ¤ & ë£¨í”„
    ========================= */
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const timeEl = document.getElementById('time');
    const scoreEl = document.getElementById('score');
    const startBtn = document.getElementById('start');
    const themeBtn = document.getElementById('theme');

    function resize(){
      canvas.width = Math.floor(innerWidth * devicePixelRatio);
      canvas.height = Math.floor(innerHeight * devicePixelRatio);
    }
    addEventListener('resize', resize, {passive:true}); resize();

    function drawDots(){
      ctx.save();
      ctx.scale(devicePixelRatio, devicePixelRatio);
      for(const d of dots){
        const timeLeft = d.expireAt - performance.now();
        const alpha = timeLeft < FADE_MS ? Math.max(0, timeLeft / FADE_MS) : 1;
        ctx.globalAlpha = alpha;

        ctx.font = `${Math.round(d.r*2.2)}px "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji",system-ui,sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.lineWidth = Math.max(1, Math.round(d.r*0.08));
        ctx.strokeText(d.emoji, d.x, d.y);
        ctx.fillText(d.emoji, d.x, d.y);
      }
      ctx.globalAlpha = 1;
      ctx.restore();
    }

    function loop(ts){
      if(!running) return;
      if(!startMs) startMs = ts, lastSpawn = ts;

      nowMs = ts;
      const elapsed = ts - startMs;
      const remain = Math.max(0, (DURATION - elapsed)/1000);
      timeEl.textContent = remain.toFixed(1);

      // ìŠ¤í° íƒ€ì´ë°ì´ë©´ ìƒˆ ê²ƒ ì¶”ê°€(ê¸°ì¡´ ê²ƒì€ ìœ ì§€) â†’ ì¤‘ë³µ í—ˆìš©ë¨
      if (elapsed - (lastSpawn - startMs) >= currentSpawnInterval()) {
        spawnSome();
        lastSpawn = ts;
      }

      // ë§Œë£Œ ì œê±°(ì•ˆ ëˆ„ë¥´ë©´ ì‚¬ë¼ì§). ë§Œë£Œëœ ê²Œ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì½¤ë³´ ëŠê¹€
      const before = dots.length;
      const nowPerf = performance.now();
      dots = dots.filter(d => d.expireAt > nowPerf);
      if (dots.length < before) combo = 0;

      ctx.clearRect(0,0,canvas.width,canvas.height);
      drawDots();

      if(elapsed >= DURATION){ running=false; endGame(); return; }
      requestAnimationFrame(loop);
    }

    async function startGame(){
      await ensureGuest();
      sessionId = uuid();

      fetch(API+'/sessions',{method:'POST',headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId, sessionId, startedAt:new Date().toISOString(), deviceInfo:navigator.userAgent })
      }).catch(()=>{});

      score=0; combo=0; scoreEl.textContent='0';
      running=true; startMs=0; lastSpawn=0; dots=[];

      await playBGM(); // ì‚¬ìš©ì ì œìŠ¤ì²˜ ë‚´ì—ì„œ ì¬ìƒ
      requestAnimationFrame(loop);
    }

    async function endGame(){
      try{
        await fetch(`${API}/sessions/${sessionId}/end`, {method:'PATCH', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ endedAt:new Date().toISOString(), finalScore:score })
        });
        alert(`ë! ì ìˆ˜: ${score}`);
      }catch(e){
        alert(`ë! ì ìˆ˜: ${score} (ì—…ë¡œë“œ ì‹¤íŒ¨)`);
      }
    }

    // í´ë¦­(í„°ì¹˜) íŒì •: ë§¨ ìœ„(ë§ˆì§€ë§‰ ê·¸ë ¤ì§„ ê²ƒ)ë¶€í„° í•˜ë‚˜ë§Œ ì œê±°
    canvas.addEventListener('pointerdown', e=>{
      if(!running) return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left, y = e.clientY - rect.top;

      for(let i=dots.length-1;i>=0;i--){
        const d = dots[i];
        const dx = x - d.x, dy = y - d.y;
        if(dx*dx + dy*dy <= d.r*d.r){
          combo = Math.min(combo+1, 5);
          score += 1 + combo;
          scoreEl.textContent = String(score);
          dots.splice(i,1);
          if(navigator.vibrate) navigator.vibrate(10);
          return;
        }
      }
      combo = 0; // ë¹—ë‚˜ê°€ë©´ ì½¤ë³´ ëŠê¹€
    },{passive:true});

    // Start í•œ ê³³ì—ì„œë§Œ ë°”ì¸ë”©(ì¤‘ë³µ ë°©ì§€)
    startBtn.onclick = startGame;

    /* =========================
       í…Œë§ˆ ë¡œì§
    ========================= */
    const THEMES = [
      {name:'Meadow', class:'theme-meadow'},
      {name:'Night',  class:'theme-night'},
      {name:'Ocean',  class:'theme-ocean'},
    ];
    let themeIndex = parseInt(localStorage.getItem('themeIndex') ?? '0', 10);
    function applyTheme(idx){
      document.body.classList.remove(...THEMES.map(t=>t.class));
      document.body.classList.add(THEMES[idx].class);
      themeBtn.textContent = THEMES[idx].name;
      localStorage.setItem('themeIndex', String(idx));
    }
    themeBtn.onclick = ()=>{
      themeIndex = (themeIndex + 1) % THEMES.length;
      applyTheme(themeIndex);
    };
    if(Number.isNaN(themeIndex) || themeIndex<0 || themeIndex>=THEMES.length) themeIndex=0;
    applyTheme(themeIndex);

    /* =========================
       BGM: 1ê³¡ ë¬´í•œ ë°˜ë³µ
    ========================= */
    const bgmEl = document.getElementById('bgm');
    const bgmToggleBtn = document.getElementById('bgm-toggle');
    let bgmEnabled = (localStorage.getItem('bgmEnabled') ?? '1') === '1';
    bgmEl.volume = 0.6;

    function updateBgmIcon(){
      bgmToggleBtn.textContent = bgmEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
    }
    async function playBGM(){
      if(!bgmEnabled) return;
      try { await bgmEl.play(); } catch(e) {}
      updateBgmIcon();
    }
    function stopBGM(){
      bgmEl.pause();
      updateBgmIcon();
    }
    bgmToggleBtn.onclick = async ()=>{
      bgmEnabled = !bgmEnabled;
      localStorage.setItem('bgmEnabled', bgmEnabled ? '1' : '0');
      if(bgmEnabled) await playBGM(); else stopBGM();
    };
    updateBgmIcon();

    // íƒ­ ì „í™˜ ì‹œ ì¼ì‹œì •ì§€/ë³µê·€(ì„ íƒ)
    document.addEventListener('visibilitychange', ()=>{
      if(document.hidden) bgmEl.pause();
      else if(running && bgmEnabled) playBGM();
    });
</script>
</body>
</html>
